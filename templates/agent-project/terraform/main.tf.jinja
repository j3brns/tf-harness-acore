provider "aws" {
  region = var.region

  default_tags {
    tags = {
      Project     = var.agent_name
      Environment = var.environment
      ManagedBy   = "terraform"
    }
  }
}

# OIDC Discovery (Build-time Discovery)
data "http" "oidc_config" {
  count = {{ enable_bff | lower }} ? 1 : 0
  url   = "${trimsuffix(var.oidc_issuer, "/")}/.well-known/openid-configuration"
}

locals {
  oidc_discovery = try(jsondecode(data.http.oidc_config[0].response_body), {})
}

# -----------------------------------------------------------------------------
# Module Orchestration
# -----------------------------------------------------------------------------

module "agentcore_foundation" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-foundation?ref=v0.1.1"

  agent_name     = var.agent_name
  region         = var.region
  bedrock_region = var.region
  environment    = var.environment

  # Gateway configuration
  enable_gateway      = true
  gateway_name        = "${var.agent_name}-gateway"
  gateway_search_type = "HYBRID"

  # Identity configuration
  enable_identity = {{ enable_identity | lower if enable_identity is defined else 'false' }}
  oidc_issuer     = var.oidc_issuer

  # Observability
  enable_observability = true
  log_retention_days   = 30
  enable_xray          = true
}

module "agentcore_tools" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-tools?ref=v0.1.1"

  agent_name = var.agent_name
  region     = var.region

  # Code interpreter
  enable_code_interpreter       = {{ enable_code_interpreter | lower }}
  code_interpreter_network_mode = "SANDBOX"

  # Browser
  enable_browser       = false
  browser_network_mode = "SANDBOX"
}

module "agentcore_runtime" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-runtime?ref=v0.1.1"

  agent_name     = var.agent_name
  app_id         = var.app_id
  region         = var.region
  bedrock_region = var.region
  environment    = var.environment

  # Runtime configuration
  enable_runtime      = true
  runtime_source_path = "${path.module}/../agent-code"

  # Memory configuration
  enable_memory = true
  memory_type   = "BOTH"

  # Integration
  logging_bucket_id     = module.agentcore_foundation.access_logs_bucket_id
  inference_profile_arn = module.agentcore_foundation.inference_profile_arn
  proxy_role_arn        = module.agentcore_bff.proxy_role_arn

  # Packaging
  enable_packaging = true
  python_version   = "{{ python_version }}"

  depends_on = [
    module.agentcore_foundation
  ]
}

module "agentcore_governance" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-governance?ref=v0.1.1"

  agent_name     = var.agent_name
  region         = var.region
  bedrock_region = var.region

  # Policy engine
  enable_policy_engine = false

  # Guardrails
  enable_guardrails     = {{ enable_guardrails | lower }}
  guardrail_name        = "${var.agent_name}-guardrail"
  guardrail_description = "Safety guardrail for ${var.agent_name}"

  # Evaluations
  enable_evaluations = false

  depends_on = [
    module.agentcore_foundation,
    module.agentcore_runtime
  ]
}

module "agentcore_bff" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-bff?ref=v0.1.1"

  enable_bff            = {{ enable_bff | lower }}
  agent_name            = var.agent_name
  app_id                = var.app_id
  region                = var.region
  agentcore_region      = var.region
  environment           = var.environment
  agentcore_runtime_arn = module.agentcore_runtime.runtime_arn

  # Auth Configuration
  oidc_issuer                 = var.oidc_issuer
  oidc_authorization_endpoint = try(local.oidc_discovery.authorization_endpoint, "")
  oidc_token_endpoint         = try(local.oidc_discovery.token_endpoint, "")
  oidc_client_id              = var.oidc_client_id
  oidc_client_secret_arn      = var.oidc_client_secret_arn

  # Integration
  logging_bucket_id          = module.agentcore_foundation.access_logs_bucket_id
  waf_acl_arn                = module.agentcore_foundation.waf_acl_arn
  agentcore_runtime_role_arn = module.agentcore_runtime.runtime_role_arn
}
