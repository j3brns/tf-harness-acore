terraform {
  required_version = ">= 1.5.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 6.0" # Required for native BFF response streaming
    }
    http = {
      source  = "hashicorp/http"
      version = ">= 3.0"
    }
  }
}

provider "aws" {
  region = "{{ region }}"
  default_tags {
    tags = {
      Project = "{{ agent_name }}"
      ManagedBy = "Terraform"
    }
  }
}

# OIDC Discovery (Build-time Discovery)
data "http" "oidc_config" {
  count = {{ enable_bff | lower }} ? 1 : 0
  url   = "${trimsuffix(local.oidc_issuer, "/")}/.well-known/openid-configuration"
}

locals {
  app_id = "{{ app_id }}"
  oidc_issuer = "https://login.microsoftonline.com/YOUR_TENANT_ID/v2.0"
  oidc_discovery = try(jsondecode(data.http.oidc_config[0].response_body), {})
}

# Root module - orchestrates all AgentCore components

module "agentcore_foundation" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-foundation?ref=main"

  agent_name  = "{{ agent_name }}"
  region      = "{{ region }}"
  bedrock_region = "{{ region }}"
  environment = "{{ environment }}"

  # Gateway configuration
  enable_gateway      = true
  gateway_name        = "{{ agent_name }}-gateway"
  gateway_search_type = "HYBRID"

  # Identity configuration
  enable_identity   = false

  # Observability
  enable_observability = true
  log_retention_days   = 30
  enable_xray          = true
}

module "agentcore_tools" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-tools?ref=main"

  agent_name = "{{ agent_name }}"
  region     = "{{ region }}"

  # Code interpreter
  enable_code_interpreter       = {{ enable_code_interpreter | lower }}
  code_interpreter_network_mode = "SANDBOX"

  # Browser
  enable_browser              = false
  browser_network_mode        = "SANDBOX"
}

module "agentcore_runtime" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-runtime?ref=main"

  agent_name = "{{ agent_name }}"
  app_id     = local.app_id
  region     = "{{ region }}"
  bedrock_region = "{{ region }}"
  environment = "{{ environment }}"

  # Runtime configuration
  enable_runtime          = true
  runtime_source_path     = "../agent-code"

  # Memory configuration
  enable_memory = true
  memory_type   = "BOTH"

  # Packaging
  enable_packaging = true
  python_version   = "{{ python_version }}"

  depends_on = [
    module.agentcore_foundation
  ]
}

module "agentcore_governance" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-governance?ref=main"

  agent_name = "{{ agent_name }}"
  region     = "{{ region }}"
  bedrock_region = "{{ region }}"

  # Policy engine
  enable_policy_engine   = false

  # Guardrails
  enable_guardrails                   = {{ enable_guardrails | lower }}
  guardrail_name                      = "{{ agent_name }}-guardrail"
  guardrail_description               = "Safety guardrail for {{ agent_name }}"

  # Evaluations
  enable_evaluations  = false

  depends_on = [
    module.agentcore_foundation,
    module.agentcore_runtime
  ]
}

module "agentcore_bff" {
  source = "github.com/j3brns/tf-harness-acore//terraform/modules/agentcore-bff?ref=main"

  enable_bff  = {{ enable_bff | lower }}
  agent_name  = "{{ agent_name }}"
  app_id      = local.app_id
  region      = "{{ region }}"
  agentcore_region = "{{ region }}"
  environment = "{{ environment }}"
  agentcore_runtime_arn = module.agentcore_runtime.runtime_arn

  # Auth Configuration (Placeholders - MUST be updated)
  oidc_issuer                 = local.oidc_issuer
  oidc_authorization_endpoint = try(local.oidc_discovery.authorization_endpoint, "")
  oidc_token_endpoint         = try(local.oidc_discovery.token_endpoint, "")
  oidc_client_id              = "YOUR_CLIENT_ID"
  oidc_client_secret_arn      = "arn:aws:secretsmanager:{{ region }}:YOUR_ACCOUNT:secret:YOUR_SECRET"

  depends_on = [
    module.agentcore_foundation
  ]
}
