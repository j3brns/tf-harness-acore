# Pre-commit hooks for Bedrock AgentCore Terraform
#
# Install: pip install pre-commit && pre-commit install
# Run all: pre-commit run --all-files
# Update:  pre-commit autoupdate

repos:
  # Terraform formatting and validation
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.96.1
    hooks:
      - id: terraform_fmt
        name: Terraform Format
        description: Rewrites Terraform files to canonical format

      - id: terraform_validate
        name: Terraform Validate
        description: Validates Terraform configuration
        args:
          - --hook-config=--retry-once-with-cleanup=true

      - id: terraform_docs
        name: Terraform Docs
        description: Generate documentation from Terraform modules
        args:
          - --hook-config=--path-to-file=README.md
          - --hook-config=--add-to-existing-file=true
          - --hook-config=--create-file-if-not-exist=true

      - id: terraform_tflint
        name: TFLint
        description: Linter for Terraform
        args:
          - --args=--config=__GIT_WORKING_DIR__/terraform/.tflint.hcl

      - id: terraform_checkov
        name: Checkov Security Scan
        description: Security and compliance scanner
        args:
          - --args=--quiet
          - --args=--compact
          - --args=--config-file=__GIT_WORKING_DIR__/terraform/.checkov.yaml
          - --args=--skip-check CKV_AWS_144  # S3 cross-region replication (not needed)
          - --args=--skip-check CKV_AWS_145  # S3 KMS encryption (using SSE-S3)
          - --args=--skip-check CKV_AWS_158  # CloudWatch Logs KMS encryption (AWS-managed)
          - --args=--skip-check CKV_AWS_338  # Log retention >= 1 year
          - --args=--skip-check CKV2_AWS_61  # S3 lifecycle configuration
          - --args=--skip-check CKV_AWS_21   # S3 versioning (separate resource)
          - --args=--skip-check CKV2_AWS_62  # S3 event notifications
          - --args=--skip-check CKV2_AWS_6   # S3 public access block (separate resource)
          - --args=--skip-check CKV_AWS_18  # S3 access logging

  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.6.0
    hooks:
      - id: check-yaml
        name: Check YAML
        description: Validates YAML syntax
        exclude: ^\.gitlab-ci\.yml$  # GitLab CI has special syntax

      - id: check-json
        name: Check JSON
        description: Validates JSON syntax

      - id: end-of-file-fixer
        name: Fix End of Files
        description: Ensures files end with newline

      - id: trailing-whitespace
        name: Trim Trailing Whitespace
        description: Removes trailing whitespace

      - id: check-added-large-files
        name: Check Large Files
        description: Prevents large files from being committed
        args: ['--maxkb=1000']

      - id: check-merge-conflict
        name: Check Merge Conflicts
        description: Checks for merge conflict markers

      - id: detect-private-key
        name: Detect Private Keys
        description: Prevents private keys from being committed

  # Python checks (for agent code)
  - repo: https://github.com/psf/black
    rev: 24.4.2
    hooks:
      - id: black
        name: Black Formatter
        description: Python code formatter
        types: [python]
        args: ['--line-length=120']

  - repo: https://github.com/pycqa/flake8
    rev: 7.1.0
    hooks:
      - id: flake8
        name: Flake8 Linter
        description: Python linter
        types: [python]
        args: ['--max-line-length=120', '--ignore=E203,E501,W503']

  # Documentation sync check (custom)
  - repo: local
    hooks:
      - id: docs-sync-check
        name: Check Docs Updated With Code
        description: Ensures documentation is updated when code changes
        entry: >-
          bash -c 'if git diff --cached --name-only | grep -qE "\.tf$"; then git diff --cached --name-only | grep -qE "\.md$" || { echo "ERROR: Terraform changed without doc update"; exit 1; }; fi'
        language: system
        pass_filenames: false
        always_run: true

      - id: tests-sync-check
        name: Check Tests Updated With Terraform Changes
        description: Ensures tests are updated when Terraform changes
        entry: >-
          bash -c 'if git diff --cached --name-only | grep -qE "\.tf$"; then git diff --cached --name-only | grep -qE "^(terraform/tests/|terraform/scripts/validate_examples\.sh|examples/.*/agent-code/tests/|examples/.*/tests/)" || { echo "ERROR: Terraform changed without tests"; exit 1; }; fi'
        language: system
        pass_filenames: false
        always_run: true

      - id: agent-docs-sync-check
        name: Check Agent Rule Docs In Sync
        description: Ensures AGENTS.md, CLAUDE.md, and GEMINI.md are identical
        entry: >-
          bash -c 'cmp -s AGENTS.md CLAUDE.md && cmp -s AGENTS.md GEMINI.md || { echo "ERROR: AGENTS.md, CLAUDE.md, GEMINI.md must be identical"; exit 1; }'
        language: system
        pass_filenames: false
        always_run: true

      - id: version-metadata-consistency-check
        name: Check VERSION/CHANGELOG/Docs Version Metadata Consistency
        description: Ensures VERSION, CHANGELOG, and documented version metadata stay aligned
        entry: python3 terraform/scripts/validate_version_metadata.py
        language: system
        pass_filenames: false
        always_run: true

      - id: scratch-ephemeral-check
        name: Block .scratch Commits
        description: Prevents committing ephemeral files from .scratch/
        entry: >-
          bash -c 'if git diff --cached --name-only | grep -q "^\\.scratch/"; then echo "ERROR: .scratch/ is ephemeral and must not be committed"; exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true

      - id: file-proliferation-check
        name: Prevent File Proliferation
        description: Blocks ad-hoc variant filenames and script sprawl outside approved paths
        entry: >-
          bash -c 'set -euo pipefail; ADDED="$(git diff --cached --name-only --diff-filter=A)"; [ -z "$ADDED" ] && exit 0; BAD_NAMES="$(printf "%s\n" "$ADDED" | grep -Ei "(^|/).*(copy|backup|tmp|temp|old|new|v2|v3|improved|enhanced)(\\.|_|$)" || true)"; if [ -n "$BAD_NAMES" ]; then echo "ERROR: File proliferation naming detected (copy/tmp/v2/improved/etc):"; printf "%s\n" "$BAD_NAMES"; exit 1; fi; SCRIPT_ADDED="$(printf "%s\n" "$ADDED" | grep -E "\\.(sh|bash|zsh|ps1|bat|cmd|py)$" || true)"; if [ -n "$SCRIPT_ADDED" ]; then SCRIPT_BAD="$(printf "%s\n" "$SCRIPT_ADDED" | grep -Ev "^(terraform/scripts/|examples/.*/agent-code/|templates/agent-project/agent-code/|\\.github/)" || true)"; if [ -n "$SCRIPT_BAD" ]; then echo "ERROR: New scripts must be in approved paths (terraform/scripts, example/template agent-code, .github). Use .scratch/ for ephemeral scripts."; printf "%s\n" "$SCRIPT_BAD"; exit 1; fi; fi'
        language: system
        pass_filenames: false
        always_run: true

      - id: no-placeholder-arns
        name: Check No Placeholder ARNs
        description: Prevents placeholder AWS account IDs in code
        entry: >-
          bash -c 'set -euo pipefail; FILES="$(git diff --cached --name-only | grep -E "\.(tf|tfvars|py|sh|bash|zsh|ps1|yaml|yml|json)$" | grep -v "^\\.pre-commit-config\\.yaml$" || true)"; [ -z "$FILES" ] && exit 0; echo "$FILES" | xargs grep -l "123456789012\|999999999999\|000000000000" 2>/dev/null && echo "ERROR: Placeholder ARNs found" && exit 1 || exit 0'
        language: system
        pass_filenames: false
        types: [text]
