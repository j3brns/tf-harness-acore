name: CI

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  release-tag-guard:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Ensure tag matches VERSION and CHANGELOG
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          REPO_VERSION="$(cat VERSION)"
          if [ "$TAG_VERSION" != "$REPO_VERSION" ]; then
            echo "ERROR: tag version ($TAG_VERSION) does not match VERSION ($REPO_VERSION)"
            exit 1
          fi
          grep -q "^## \[$TAG_VERSION\]" CHANGELOG.md \
            || { echo "ERROR: CHANGELOG.md missing heading for $TAG_VERSION"; exit 1; }

  docs-tests-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Enforce docs/tests on Terraform changes
        run: |
          set -euo pipefail
          BASE_REF="${{ github.base_ref }}"
          if [ -z "$BASE_REF" ]; then
            BASE_REF="${{ github.event.repository.default_branch }}"
          fi
          git fetch origin "$BASE_REF"
          CHANGED=$(git diff --name-only "origin/$BASE_REF"...HEAD)
          if printf '%s\n' "$CHANGED" | grep -qE '\.tf$'; then
            printf '%s\n' "$CHANGED" | grep -qE '\.md$' || { echo "ERROR: Terraform changed without docs"; exit 1; }
            printf '%s\n' "$CHANGED" | grep -qE '^(terraform/tests/|terraform/scripts/validate_examples\.sh|examples/.*/agent-code/tests/|examples/.*/tests/)' || { echo "ERROR: Terraform changed without tests"; exit 1; }
          fi

  openapi-client-drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Regenerate MCP OpenAPI spec
        run: make generate-openapi
      - name: Verify typed client matches regenerated MCP OpenAPI spec
        run: make check-openapi-client
      - name: Ensure generated OpenAPI artifact is committed
        run: git diff --exit-code -- docs/api/mcp-tools-v1.openapi.json

  openapi-contract-changelog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: OpenAPI contract diff classifier unit test
        run: python3 -m unittest terraform/tests/validation/test_openapi_contract_diff.py
      - name: Resolve OpenAPI diff baseline
        id: openapi-baseline
        env:
          EVENT_NAME: ${{ github.event_name }}
          BASE_REF: ${{ github.base_ref }}
          REF_NAME: ${{ github.ref_name }}
          REF: ${{ github.ref }}
          SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          SPEC_PATH="docs/api/mcp-tools-v1.openapi.json"
          BASE_SPEC="${RUNNER_TEMP}/openapi-contract-base.json"
          BASELINE_LABEL=""

          if [ "$EVENT_NAME" = "pull_request" ] && [ -n "$BASE_REF" ]; then
            git fetch origin "$BASE_REF" --depth=1
            if git cat-file -e "origin/$BASE_REF:$SPEC_PATH" 2>/dev/null; then
              git show "origin/$BASE_REF:$SPEC_PATH" > "$BASE_SPEC"
              BASELINE_LABEL="origin/$BASE_REF:$SPEC_PATH"
            fi
          elif [[ "$REF" == refs/tags/* ]]; then
            PREV_TAG="$(git describe --tags --abbrev=0 "${SHA}^" 2>/dev/null || true)"
            if [ -n "$PREV_TAG" ] && git cat-file -e "$PREV_TAG:$SPEC_PATH" 2>/dev/null; then
              git show "$PREV_TAG:$SPEC_PATH" > "$BASE_SPEC"
              BASELINE_LABEL="$PREV_TAG:$SPEC_PATH"
            fi
          else
            if git rev-parse --verify HEAD^ >/dev/null 2>&1 && git cat-file -e "HEAD^:$SPEC_PATH" 2>/dev/null; then
              git show "HEAD^:$SPEC_PATH" > "$BASE_SPEC"
              BASELINE_LABEL="HEAD^:$SPEC_PATH"
            fi
          fi

          if [ -n "$BASELINE_LABEL" ]; then
            echo "has_baseline=true" >> "$GITHUB_OUTPUT"
            echo "baseline_path=$BASE_SPEC" >> "$GITHUB_OUTPUT"
            echo "baseline_label=$BASELINE_LABEL" >> "$GITHUB_OUTPUT"
          else
            echo "has_baseline=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Generate OpenAPI contract diff summary
        if: steps.openapi-baseline.outputs.has_baseline == 'true'
        env:
          BASELINE_PATH: ${{ steps.openapi-baseline.outputs.baseline_path }}
          BASELINE_LABEL: ${{ steps.openapi-baseline.outputs.baseline_label }}
          CANDIDATE_LABEL: ${{ github.sha }}:docs/api/mcp-tools-v1.openapi.json
        run: |
          set -euo pipefail
          python3 terraform/scripts/openapi_contract_diff.py \
            --old "$BASELINE_PATH" \
            --new docs/api/mcp-tools-v1.openapi.json \
            --old-label "$BASELINE_LABEL" \
            --new-label "$CANDIDATE_LABEL" \
            --format markdown \
            > "${RUNNER_TEMP}/openapi-contract-diff.md"
          cat "${RUNNER_TEMP}/openapi-contract-diff.md" >> "$GITHUB_STEP_SUMMARY"
      - name: OpenAPI contract diff summary skipped
        if: steps.openapi-baseline.outputs.has_baseline != 'true'
        run: |
          {
            echo "## OpenAPI Contract Diff Summary"
            echo
            echo "No baseline spec was available for comparison in this run."
          } >> "$GITHUB_STEP_SUMMARY"

  governance-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Canonical tag conformance
        run: bash terraform/tests/validation/tags_test.sh
      - name: IAM wildcard exception documentation conformance
        run: python3 terraform/tests/validation/policy_wildcard_exceptions_test.py

  terraform-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/terraform-setup
        with:
          terraform_version: 1.14.4
      - name: Terraform fmt
        working-directory: terraform
        run: terraform fmt -check -recursive
      - name: Terraform init (local backend only)
        working-directory: terraform
        run: terraform init -backend=false
      - name: Terraform validate
        working-directory: terraform
        run: terraform validate

  tflint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/tflint-setup
        with:
          tflint_version: v0.50.3
          github_token: ${{ secrets.GITHUB_TOKEN }}
      - name: TFLint init
        working-directory: terraform
        run: tflint --init --config="${GITHUB_WORKSPACE}/terraform/.tflint.hcl"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: TFLint
        working-directory: terraform
        run: tflint --recursive --format compact --config="${GITHUB_WORKSPACE}/terraform/.tflint.hcl"

  checkov:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/checkov-setup
        with:
          python_version: "3.12"
      - name: Checkov scan
        run: checkov -d terraform --framework terraform --quiet --compact --config-file terraform/.checkov.yaml

  examples-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/terraform-setup
        with:
          terraform_version: 1.14.4
      - name: Validate examples (local init via script)
        run: |
          cd terraform
          bash scripts/validate_examples.sh || echo "WARN: Examples validation skipped or failed"

  template-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Copier
        run: pip install copier
      - name: Generate Project from Template
        run: |
          mkdir .generated-test
          copier copy --force --trust \
            --data agent_name=ci-agent \
            --data app_id=ci-agent \
            --data region=eu-west-2 \
            --data environment=dev \
            --data enable_bff=true \
            templates/agent-project .generated-test
      - uses: ./.github/actions/terraform-setup
        with:
          terraform_version: 1.14.4
      - name: Validate Generated Terraform
        run: |
          cd .generated-test/terraform
          terraform init -backend=false
          terraform validate
